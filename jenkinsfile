pipeline {
  agent any
  stages{

    stage('setting YC variables default.tf'){
        steps{
            sh 'sed -i "s/\$token/$(yc config get token)/g" default.tf'
            sh 'sed -i "s/\$cloud_id/$(yc config get cloud-id)/g" default.tf'
            sh 'sed -i "s/\$folder_id/$(yc config get folder-id)/g" default.tf'
        }
    }


    stage('Terraform init') {
        steps {
            echo "terraform init" 
            sh 'terraform init'
        }
    }
    stage('Terraform apply') {
        steps {
            echo "terraform apply" 
            sh 'terraform apply --auto-approve'
            }
    }


    stage('Filling in the file host for ansible'){
        steps {
            echo "Filling in the file host for ansible" 
            sh """
            echo '[build]' > /etc/ansible/hosts
            terraform output -raw nat_ip_vm_build >> /etc/ansible/hosts
            echo ' ansible_user=jenkins ansible_ssh_private_key_file=/var/lib/jenkins/.ssh/id_rsa' >> /etc/ansible/hosts
            
            echo '\n[prod]' >> /etc/ansible/hosts
            terraform output -raw  nat_ip__vm_prod >> /etc/ansible/hosts
            echo ' ansible_user=jenkins ansible_ssh_private_key_file=/var/lib/jenkins/.ssh/id_rsa' >> /etc/ansible/hosts
            
            echo '\n' >> /etc/ansible/hosts
            """
        }
    }

    stage('ansible'){
        steps{
            sh 'ansible-playbook build_push_run_Docker.yml'
        }
    }  

  }
}