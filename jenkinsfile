pipeline {
  agent any
  stages{

    stage('Terraform init') {
        steps {
            sh 'terraform init'
        }
    }
    stage('Terraform apply') {
        steps {
            sh 'terraform apply --auto-approve'
            }
    }


    stage('Filling in the file host for ansible'){
        steps {
            sh """
            echo '[build]' > /etc/ansible/hosts
            terraform output -raw nat_ip_vm_build >> /etc/ansible/hosts
            echo ' ansible_user=root ansible_ssh_private_key_file=/var/lib/jenkins/.ssh/id_rsa' >> /etc/ansible/hosts
            echo '\n[prod]' >> /etc/ansible/hosts
            terraform output -raw  nat_ip__vm_prod >> /etc/ansible/hosts
            echo ' ansible_user=root ansible_ssh_private_key_file=/var/lib/jenkins/.ssh/id_rsa' >> /etc/ansible/hosts
            echo '\n' >> /etc/ansible/hosts
            """
        }
    }

    stage('ansible'){
        steps{
            sh 'ansible-playbook build_push_run_Docker.yml'
        }
    }  

  }
}